<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head th:replace = "fragments :: head">
</head>

<style>
    .form {
        padding: 2.5%;
        padding-top: 0%;
        color: black;
        margin-top: 2%;
    }

    form{
        min-width: 200px;
        max-width: 30%;
    }
    form::before{
        max-width: 30%;
    }
</style>

<body onload="getQueries()">
    <nav th:replace = "fragments :: navigation"></nav>

    <div id="errorMessage"></div>

    <div th:if="${param.error}">Invalid username or password.</div>
    
    <form method="post" class="container form w-25" th:action="@{/login}" th:object = "${user}">
        <h1 class="display-5 form_header">Login</h1>
        <div class="form-group">
            <label for="username">Username</label>
            <input class="form-control" name="username" id="username"/>
        </div>
        <div class="form-group">
            <label for="passwordTB">Password</label>
            <input class="form-control" name="password" id="password" type="password"/>
        </div>
        <div class="form-group">
            <label for="stay-loggedIn" id="submit-label">Stay Logged In: </label>
            <input type="checkbox" name="stay-loggedIn" id="stay-loggedIn"/>
        </div>

        <button type="submit" class="btn btn-primary btn-lg btn-block" id="loginBtn" >Sign In</button>
    </form>
</body>

<script>

    $(document).ready(function(){
    });

    $("#loginBtn").click(function(event){
        var username = $("#username").val();
        var password = $("#password").val();
        $.post("login/" + username + "/" + password, function(data){
            if(data == "success"){
                if($("#stay-loggedIn").is(":checked")){
                    setCookie("stayLoggedIn", "1", 30);
                    setCookie("username", username, 30);
                    setCookie("password", password, 30);
                } else {
                    setCookie("stayLoggedIn", "0", -1);
                    setCookie("username", username, -1);
                    setCookie("password", password, -1);
                }

                window.location = "/";
            } else {
                displayError(data);
            }
        });
        event.preventDefault();
        
    });

    $("#errorMessage").click(function(){
        $("#errorMessage").text("");
        $("#password").val("");
    });

    function displayError(errorMessage){
        document.getElementById("errorMessage").innerText = errorMessage;
    }

    //https://stackoverflow.com/questions/31542032/how-to-add-default-values-to-input-fields-in-thymeleaf?rq=1
    //Many thanks to Kingamere on stack overflow.
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        let regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function getQueries(){
        let errors = getParameterByName("errors");
        let username = getParameterByName("username");

        displayError(errors);
        document.getElementById("username").value = username;
    }

    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires="+ d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for(var i = 0; i <ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }
</script>
</html>